<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor APS - Camanducaia</title>
    
    <!-- Tailwind CSS & Chart.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Smooth transitions */
        .action-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-card:active { transform: scale(0.95); }

        .nav-tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #1d4ed8;
            font-weight: 700;
        }

        /* Responsive Modal */
        #modal-overlay { transition: opacity 0.3s ease; }
        #modal-container { transition: transform 0.3s ease, opacity 0.3s ease; }

        /* Table adjustments for Mobile */
        .poeps-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .poeps-table th, .poeps-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; vertical-align: top; }
        .poeps-table th { background: #f8fafc; font-weight: 700; text-transform: uppercase; color: #475569; font-size: 0.65rem; }

        /* Hide scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Aspect ratio for charts on mobile */
        .chart-container { position: relative; height: 300px; width: 100%; }
        @media (max-width: 640px) {
            .chart-container { height: 250px; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- SETUP FLOW (Login) -->
    <div id="setup-flow" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[500] px-4">
        <div class="bg-white p-6 sm:p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl mx-auto mb-6">M</div>
            <h1 class="text-2xl font-extrabold text-slate-800 mb-2">Monitor APS</h1>
            <p class="text-slate-500 mb-8 text-sm">Gest√£o de Camanducaia - MG</p>
            
            <div class="space-y-4">
                <select id="setup-muni" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition text-sm">
                    <option value="camanducaia">Camanducaia - MG</option>
                </select>
                <input type="password" id="setup-pass" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition text-sm" placeholder="Senha de acesso">
                <button onclick="handleLogin()" class="w-full py-4 bg-blue-600 text-white font-bold rounded-2xl hover:bg-blue-700 transition shadow-lg shadow-blue-200">Acessar Painel</button>
                <p id="login-error" class="text-red-500 text-sm font-semibold hidden mt-2">Senha incorreta.</p>
            </div>
        </div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div id="app-container" class="hidden flex flex-col h-full">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 flex flex-col shrink-0 z-50">
            <div class="px-4 sm:px-8 flex items-center justify-between h-16">
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-sm">M</div>
                    <span class="font-extrabold text-lg tracking-tight text-slate-900">APS Monitor</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="display-muni-name" class="hidden sm:block text-xs font-bold text-slate-500">Camanducaia - MG</span>
                    <button onclick="location.reload()" class="p-2 bg-slate-100 rounded-full text-slate-400 hover:text-red-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" stroke-width="2"></path></svg>
                    </button>
                </div>
            </div>
            
            <!-- Navigation Tabs (Scrollable on mobile) -->
            <nav class="flex px-2 sm:px-6 overflow-x-auto no-scrollbar border-t border-slate-50">
                <button onclick="setTeamType('esf_eap')" id="tab-esf" class="px-4 py-3 nav-tab-active shrink-0 flex items-center gap-2 text-xs transition-all">
                    <span>ü©∫</span> eSF / eAP
                </button>
                <button onclick="setTeamType('esb')" id="tab-esb" class="px-4 py-3 text-slate-500 shrink-0 flex items-center gap-2 text-xs font-semibold transition-all">
                    <span>ü¶∑</span> Sa√∫de Bucal
                </button>
                <button onclick="setTeamType('emulti')" id="tab-emulti" class="px-4 py-3 text-slate-500 shrink-0 flex items-center gap-2 text-xs font-semibold transition-all">
                    <span>üë•</span> eMulti
                </button>
            </nav>
        </header>

        <div class="flex flex-1 overflow-hidden flex-col md:flex-row">
            <!-- Team Selection Sidebar (Desktop) / Dropdown (Mobile) -->
            <aside id="sidebar" class="w-full md:w-72 bg-white border-b md:border-b-0 md:border-r border-slate-200 flex flex-col overflow-hidden shrink-0">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 hidden md:block text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    Unidades / Equipes
                </div>
                <!-- Horizontal scroll on mobile, vertical on desktop -->
                <div id="team-list" class="flex md:flex-col overflow-x-auto md:overflow-y-auto p-2 md:p-4 gap-1 no-scrollbar"></div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-8 bg-slate-50/50">
                <div class="max-w-6xl mx-auto space-y-6 sm:space-y-10">
                    <div class="pb-4 border-b border-slate-200">
                        <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-1">Painel de A√ß√µes</p>
                        <h2 id="main-title" class="text-2xl sm:text-3xl font-extrabold text-slate-800 tracking-tight">--</h2>
                    </div>

                    <!-- Actions Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6" id="actions-grid">
                        <!-- Buttons added dynamically based on type -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[600] flex items-center justify-center opacity-0 pointer-events-none p-0 sm:p-6 lg:p-10">
        <div id="modal-container" class="bg-white w-full h-full sm:rounded-[2rem] lg:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden scale-95 opacity-0">
            <div class="px-6 py-4 sm:px-10 sm:py-6 border-b border-slate-100 flex justify-between items-center shrink-0">
                <div class="pr-4">
                    <h3 id="modal-title" class="text-lg sm:text-2xl font-black text-slate-800 uppercase tracking-tight truncate">--</h3>
                    <p id="modal-subtitle" class="text-xs text-slate-400 font-medium truncate">--</p>
                </div>
                <button onclick="closeModal()" class="min-w-[40px] h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-xl bg-slate-100 text-slate-400 active:bg-red-100 active:text-red-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"></path></svg>
                </button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto p-4 sm:p-10 bg-slate-50/30"></div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        const TECH_METADATA = {
            "esf_eap": {
                "C1": { title: "Mais Acesso √† APS", meta: "50-70%" },
                "C2": { title: "Desenv. Infantil", meta: ">75%" },
                "C3": { title: "Gesta√ß√£o e Puerp√©rio", meta: ">75%" },
                "C4": { title: "Diabetes", meta: ">75%" },
                "C5": { title: "Hipertens√£o", meta: ">75%" },
                "C6": { title: "Pessoa Idosa", meta: ">75%" },
                "C7": { title: "Preven√ß√£o C√¢ncer", meta: ">75%" }
            },
            "esb": {
                "B1": { title: "1¬™ Consulta", meta: "100%" },
                "B2": { title: "Tratamento Conclu√≠do", meta: "100%" },
                "B3": { title: "Raz√£o de Exodontia", meta: "8%" },
                "B4": { title: "A√ß√µes Coletivas", meta: "100%" },
                "B5": { title: "Procedimentos Preventivos", meta: "100%" },
                "B6": { title: "Tratamento ART", meta: "15%" }
            },
            "emulti": {
                "M1": { title: "M√©dia Atendimentos", meta: "2.0" },
                "M2": { title: "A√ß√µes Interprofissionais", meta: "2.0%" }
            }
        };

        const ALL_TEAMS_DATA = {
            "esf_centro": { name: "eSF Centro", indicators: { "C1": {num: 586, den: 2817}, "C2": {num: 120, den: 6}, "C3": {num: 138, den: 3}, "C4": {num: 115.25, den: 1.64}, "C5": {num: 265.25, den: 3.55}, "C6": {num: 320.25, den: 5.43}, "C7": {prev: {num: 162, den: 704}, vax: {num: 25, den: 77}, cons: {num: 93, den: 923}, mamo: {num: 42, den: 328}} }, vinculo: { cadTotal: 2267, cadComplete: 2154, cadIncomplete: 113, cadIndOnly: 68, param: 2500, acompTotal: 2082 } },
            "esf_cruzeiro": { name: "eSF Cruzeiro", indicators: { "C1": {num: 662, den: 2678}, "C2": {num: 300, den: 11}, "C3": {num: 195, den: 4}, "C4": {num: 161.4, den: 2.04}, "C5": {num: 388.75, den: 4.59}, "C6": {num: 415.75, den: 6.41}, "C7": {prev: {num: 282, den: 815}, vax: {num: 69, den: 120}, cons: {num: 145, den: 1107}, mamo: {num: 56, den: 345}} }, vinculo: { cadTotal: 3026, cadComplete: 2935, cadIncomplete: 91, cadIndOnly: 91, param: 2500, acompTotal: 2896 } },
            "esf_loteamento": { name: "eSF Loteamento", indicators: { "C1": {num: 944, den: 2678}, "C2": {num: 80, den: 7}, "C3": {num: 534, den: 8}, "C4": {num: 215.9, den: 2.97}, "C5": {num: 439.25, den: 6.16}, "C6": {num: 368.75, den: 6.14}, "C7": {prev: {num: 375, den: 996}, vax: {num: 114, den: 133}, cons: {num: 270, den: 1325}, mamo: {num: 122, den: 413}} }, vinculo: { cadTotal: 3466, cadComplete: 3466, cadIncomplete: 0, cadIndOnly: 0, param: 2500, acompTotal: 2756 } },
            "esf_monte_verde": { name: "eSF Monte Verde", indicators: { "C1": {num: 406, den: 2286}, "C2": {num: 1480, den: 21}, "C3": {num: 541, den: 13}, "C4": {num: 113.85, den: 1.64}, "C5": {num: 267.5, den: 3.63}, "C6": {num: 304.75, den: 5.52}, "C7": {prev: {num: 287, den: 967}, vax: {num: 57, den: 132}, cons: {num: 47, den: 1254}, mamo: {num: 58, den: 408}} }, vinculo: { cadTotal: 3217, cadComplete: 3217, cadIncomplete: 0, cadIndOnly: 0, param: 2500, acompTotal: 2876 } },
            "esf_ponte_nova": { name: "eSF Ponte Nova", indicators: { "C1": {num: 532, den: 1243}, "C2": {num: 60, den: 7}, "C3": {num: 247, den: 6}, "C4": {num: 92.35, den: 1.39}, "C5": {num: 215, den: 3.47}, "C6": {num: 169.25, den: 3.86}, "C7": {prev: {num: 142, den: 621}, vax: {num: 45, den: 109}, cons: {num: 48, den: 816}, mamo: {num: 21, den: 259}} }, vinculo: { cadTotal: 2153, cadComplete: 2131, cadIncomplete: 22, cadIndOnly: 0, param: 2500, acompTotal: 1522 } },
            "esf_quedas_verdes": { name: "eSF Quedas Verdes", indicators: { "C1": {num: 377, den: 1408}, "C2": {num: 200, den: 13}, "C3": {num: 355, den: 10}, "C4": {num: 117.6, den: 1.86}, "C5": {num: 295.75, den: 4.22}, "C6": {num: 269.25, den: 4.72}, "C7": {prev: {num: 239, den: 596}, vax: {num: 57, den: 101}, cons: {num: 51, den: 793}, mamo: {num: 83, den: 269}} }, vinculo: { cadTotal: 2195, cadComplete: 2129, cadIncomplete: 66, cadIndOnly: 66, param: 2500, acompTotal: 1939 } },
            "esf_sao_mateus": { name: "eSF S√£o Mateus", indicators: { "C1": {num: 475, den: 2848}, "C2": {num: 400, den: 10}, "C3": {num: 429, den: 9}, "C4": {num: 166.7, den: 1.97}, "C5": {num: 359.25, den: 4.55}, "C6": {num: 371.25, den: 6.17}, "C7": {prev: {num: 168, den: 655}, vax: {num: 56, den: 99}, cons: {num: 76, den: 845}, mamo: {num: 103, den: 336}} }, vinculo: { cadTotal: 2420, cadComplete: 2347, cadIncomplete: 73, cadIndOnly: 49, param: 2500, acompTotal: 2195 } },
            "esb_cruzeiro": { name: "eSB Cruzeiro", indicators: { "B1": {num: 256, den: 6112}, "B2": {num: 148, den: 180}, "B3": {num: 114, den: 1434}, "B4": {num: 32, den: 548}, "B5": {num: 698, den: 3354}, "B6": {num: 6, den: 330} } },
            "esb_monte_verde": { name: "eSB Monte Verde", indicators: { "B1": {num: 24, den: 3190}, "B2": {num: 10, den: 12}, "B3": {num: 4, den: 80}, "B4": {num: 1, den: 292}, "B5": {num: 28, den: 246}, "B6": {num: 0, den: 17} } },
            "emulti_01": { name: "eMulti 01", indicators: { "M1": {num: 3169, den: 890}, "M2": {num: 111, den: 2992} } },
            "emulti_02": { name: "eMulti 02", indicators: { "M1": {num: 2608, den: 413}, "M2": {num: 6, den: 2222} } },
            "emulti_03": { name: "eMulti 03", indicators: { "M1": {num: 808, den: 178}, "M2": {num: 8, den: 1261} } }
        };

        const PSE_SCHOOLS = {
            "esf_centro": "CMEI Milton Salles", "esf_cruzeiro": "E. Moreira Brand√£o e CEMEI Luiz Chiaradia", "esf_loteamento": "PEM Adolfa Maria Orka Plogger", "esf_monte_verde": "Karlis Kempis e Verner", "esf_ponte_nova": "E. Arauc√°ria e Prudente de Moraes", "esf_quedas_verdes": "Rui Marzag√£o de Carvalho", "esf_sao_mateus": "EM Francisco Leite Melo"
        };

        let currentTeamType = "esf_eap";
        let currentTeamId = "esf_centro";
        let barChartInstance = null;

        // --- AUTH ---
        function handleLogin() {
            const pass = document.getElementById('setup-pass').value;
            if (pass === "022025" || pass === "julia") {
                document.getElementById('setup-flow').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                setTeamType('esf_eap');
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        // --- NAVIGATION ---
        function setTeamType(type) {
            currentTeamType = type;
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('nav-tab-active');
                b.classList.add('text-slate-500');
            });
            const activeTab = document.getElementById(`tab-${type.replace('esf_eap', 'esf')}`);
            activeTab.classList.add('nav-tab-active');
            activeTab.classList.remove('text-slate-500');

            renderTeamList();
            renderActionButtons();
        }

        function renderTeamList() {
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            
            const teams = Object.keys(ALL_TEAMS_DATA).filter(id => {
                if (currentTeamType === 'esf_eap') return id.startsWith('esf');
                if (currentTeamType === 'esb') return id.startsWith('esb');
                if (currentTeamType === 'emulti') return id.startsWith('emulti');
                return false;
            });

            teams.forEach(id => {
                const btn = document.createElement('button');
                btn.onclick = () => selectTeam(id);
                btn.id = `side-${id}`;
                btn.className = "flex-none md:flex-shrink-0 md:w-full text-left px-4 py-3 rounded-xl text-xs font-semibold transition-all whitespace-nowrap md:whitespace-normal mb-1 border md:border-0 border-slate-100";
                btn.innerText = ALL_TEAMS_DATA[id].name;
                list.appendChild(btn);
            });
            if (teams.length > 0) selectTeam(teams[0]);
        }

        function selectTeam(id) {
            document.querySelectorAll('#team-list button').forEach(b => {
                b.className = "flex-none md:flex-shrink-0 md:w-full text-left px-4 py-3 rounded-xl text-xs font-semibold transition-all whitespace-nowrap md:whitespace-normal mb-1 border md:border-0 border-slate-100 text-slate-600 bg-white";
            });
            const activeBtn = document.getElementById(`side-${id}`);
            if (activeBtn) activeBtn.className = "flex-none md:flex-shrink-0 md:w-full text-left px-4 py-3 rounded-xl text-xs font-bold bg-blue-600 text-white shadow-md mb-1 whitespace-nowrap md:whitespace-normal";
            
            currentTeamId = id;
            document.getElementById('main-title').innerText = ALL_TEAMS_DATA[id].name;
        }

        function renderActionButtons() {
            const grid = document.getElementById('actions-grid');
            const commonActions = [
                { id: 'indicadores', icon: 'üìä', title: 'Indicadores de Qualidade', color: 'border-blue-200 hover:bg-blue-50' }
            ];

            const esfActions = [
                { id: 'vinculo', icon: 'üîó', title: 'V√≠nculo e Acompanhamento', color: 'border-indigo-200 hover:bg-indigo-50' },
                { id: 'poeps-plan', icon: 'üóìÔ∏è', title: 'POEPS Planejamento', color: 'border-emerald-200 hover:bg-emerald-50' },
                { id: 'poeps-eval', icon: 'üìã', title: 'POEPS Avalia√ß√£o', color: 'border-orange-200 hover:bg-orange-50' },
                { id: 'pse', icon: 'üè´', title: 'PSE Escolas', color: 'border-teal-200 hover:bg-teal-50' }
            ];

            const allActions = currentTeamType === 'esf_eap' ? [...commonActions, ...esfActions] : commonActions;

            grid.innerHTML = allActions.map(act => `
                <button onclick="openModal('${act.id}')" class="action-card bg-white p-6 rounded-[2rem] border ${act.color} shadow-sm flex items-center gap-4 text-left">
                    <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-2xl shadow-sm border border-slate-50">${act.icon}</div>
                    <span class="text-sm font-bold text-slate-700 leading-tight">${act.title}</span>
                </button>
            `).join('');
        }

        // --- CALCULATIONS ---
        function calculateScore(code, teamId) {
            const data = ALL_TEAMS_DATA[teamId].indicators[code];
            if (!data) return 0;
            if (code === 'C1' || code === 'M2') return (data.num / data.den) * 100;
            if (code === 'M1') return (data.num / data.den);
            if (code === 'C7') {
                return ((data.prev.num / data.prev.den) * 20) + ((data.vax.num / data.vax.den) * 30) + ((data.cons.num / data.cons.den) * 30) + ((data.mamo.num / data.mamo.den) * 20);
            }
            if (['C2', 'C3', 'C4', 'C5', 'C6'].includes(code)) return (data.num / data.den); // J√° dividido por 100 conforme solicitado anteriormente
            return (data.num / data.den) * 100;
        }

        function getClassification(score, code) {
            // Azul: √ìtimo, Verde: Bom, Amarelo: Suficiente, Vermelho: Regular
            if (code === 'C1') {
                if (score > 50 && score <= 70) return { label: "√ìtimo", color: "text-blue-600", hex: "#2563eb" };
                if (score > 30 && score <= 50) return { label: "Bom", color: "text-green-600", hex: "#16a34a" };
                if (score > 10 && score <= 30) return { label: "Suficiente", color: "text-yellow-600", hex: "#ca8a04" };
                return { label: "Regular", color: "text-red-600", hex: "#dc2626" };
            }
            if (code === 'M1') return score >= 2 ? { label: "√ìtimo", color: "text-blue-600", hex: "#2563eb" } : { label: "Regular", color: "text-red-600", hex: "#dc2626" };
            if (code === 'M2') {
                if (score >= 2.0) return { label: "Bom", color: "text-green-600", hex: "#16a34a" };
                if (score > 0) return { label: "Suficiente", color: "text-yellow-600", hex: "#ca8a04" };
                return { label: "Regular", color: "text-red-600", hex: "#dc2626" };
            }
            if (score > 75) return { label: "√ìtimo", color: "text-blue-600", hex: "#2563eb" };
            if (score > 50) return { label: "Bom", color: "text-green-600", hex: "#16a34a" };
            if (score > 25) return { label: "Suficiente", color: "text-yellow-600", hex: "#ca8a04" };
            return { label: "Regular", color: "text-red-600", hex: "#dc2626" };
        }

        // --- MODAL & RENDERING ---
        function openModal(module) {
            document.getElementById('modal-overlay').classList.remove('pointer-events-none', 'opacity-0');
            document.getElementById('modal-container').classList.remove('scale-95', 'opacity-0');
            
            if (module === 'indicadores') renderIndicadores();
            else if (module === 'vinculo') renderVinculo();
            else if (module === 'poeps-plan') renderPoepsPlan();
            else if (module === 'poeps-eval') renderPoepsEval();
            else if (module === 'pse') renderPSE();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('modal-container').classList.add('scale-95', 'opacity-0');
            if (barChartInstance) barChartInstance.destroy();
        }

        function renderIndicadores() {
            const team = ALL_TEAMS_DATA[currentTeamId];
            const codes = Object.keys(team.indicators);
            
            document.getElementById('modal-title').innerText = "Indicadores de Qualidade";
            document.getElementById('modal-subtitle').innerText = team.name;

            document.getElementById('modal-body').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-3xl border shadow-sm">
                        <div class="chart-container"><canvas id="barChart"></canvas></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 h-fit">
                        ${codes.map(c => {
                            const score = calculateScore(c, currentTeamId);
                            const cls = getClassification(score, c);
                            return `
                                <div class="bg-white p-3 rounded-2xl border flex flex-col justify-center">
                                    <span class="text-[9px] font-black text-slate-400 uppercase">${c}</span>
                                    <span class="text-xl font-black ${cls.color}">${c === 'M1' ? score.toFixed(2) : score.toFixed(1) + '%'}</span>
                                    <span class="text-[8px] font-bold uppercase ${cls.color}">${cls.label}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const scores = codes.map(c => calculateScore(c, currentTeamId));
                const colors = codes.map(c => getClassification(calculateScore(c, currentTeamId), c).hex);
                barChartInstance = new Chart(document.getElementById('barChart'), {
                    type: 'bar',
                    data: { labels: codes, datasets: [{ data: scores, backgroundColor: colors, borderRadius: 6 }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
                });
            }, 100);
        }

        function renderVinculo() {
            const data = ALL_TEAMS_DATA[currentTeamId].vinculo;
            document.getElementById('modal-title').innerText = "V√≠nculo e Acompanhamento";
            document.getElementById('modal-body').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-white p-6 rounded-3xl border shadow-sm">
                        <h4 class="text-xs font-black text-indigo-500 uppercase tracking-widest mb-4 border-b pb-2">Dados de Cadastro</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs"><span>Total de Cadastros</span><span class="font-bold">${data.cadTotal}</span></div>
                            <div class="flex justify-between text-xs text-green-600"><span>Completos e Atualizados</span><span class="font-bold">${data.cadComplete}</span></div>
                            <div class="flex justify-between text-xs text-red-500"><span>Incompletos e/ou Desatualizados</span><span class="font-bold">${data.cadIncomplete}</span></div>
                            <div class="flex justify-between text-xs text-yellow-600"><span>Apenas Cadastro Individual Atualizado</span><span class="font-bold">${data.cadIndOnly}</span></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border shadow-sm">
                        <h4 class="text-xs font-black text-emerald-500 uppercase tracking-widest mb-4 border-b pb-2">Acompanhamento</h4>
                        <div class="flex justify-between text-xs"><span>Pessoas Acompanhadas</span><span class="font-bold">${data.acompTotal}</span></div>
                        <div class="flex justify-between text-xs"><span>Par√¢metro Populacional</span><span class="font-bold">${data.param}</span></div>
                        <div class="mt-4 p-4 bg-blue-600 rounded-2xl text-white text-center">
                            <p class="text-[9px] uppercase font-bold">Cobertura</p>
                            <p class="text-3xl font-black">${((data.acompTotal/data.param)*100).toFixed(1)}%</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPoepsPlan() {
            document.getElementById('modal-title').innerText = "POEPS Planejamento";
            document.getElementById('modal-body').innerHTML = `
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-4 bg-red-600 text-white flex items-center justify-between">
                        <span class="text-xs font-bold">üéóÔ∏è DEZEMBRO VERMELHO</span>
                        <span class="text-[10px] uppercase font-black">HIV/AIDS</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="poeps-table min-w-[600px]">
                            <thead><tr><th>Indicador</th><th>Meta</th><th>Respons√°vel</th><th>Registro</th></tr></thead>
                            <tbody>
                                <tr><td>Pr√°ticas Corporais</td><td>2.472 part.</td><td>Ed. F√≠sico</td><td>Ficha Coletiva</td></tr>
                                <tr><td>Educa√ß√£o em Sa√∫de</td><td>02 A√ß√µes</td><td>Equipe</td><td>Ficha Coletiva</td></tr>
                                <tr><td>Aval. Antropom√©trica</td><td>265 mens.</td><td>Todos</td><td>Prontu√°rio</td></tr>
                                <tr><td>Comit√™ Equidades</td><td>01 A√ß√£o</td><td>Comit√™</td><td>Ata/Fotos</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderPoepsEval() {
            document.getElementById('modal-title').innerText = "Avalia√ß√£o M√™s Anterior";
            const dummyEval = [
                { id: 1, meta: "1.357", real: "241", status: "N√ÉO", color: "text-red-500" },
                { id: 3, meta: "203", real: "203", status: "SIM", color: "text-green-600" },
                { id: 4, meta: "1 A√ß√£o", real: "VERIF.", status: "--", color: "text-slate-400" },
                { id: 8, meta: "28", real: "164", status: "SIM", color: "text-green-600" }
            ];
            document.getElementById('modal-body').innerHTML = `
                <div class="bg-white rounded-3xl border shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="poeps-table min-w-[400px]">
                            <thead><tr><th>Ind.</th><th>Meta</th><th>Real</th><th>Cumpriu?</th></tr></thead>
                            <tbody>
                                ${dummyEval.map(d => `
                                    <tr>
                                        <td class="font-bold">#${d.id}</td>
                                        <td>${d.meta}</td>
                                        <td>${d.real}</td>
                                        <td class="font-black ${d.color}">${d.status}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderPSE() {
            const school = PSE_SCHOOLS[currentTeamId] || "Sem escola vinculada";
            document.getElementById('modal-title').innerText = "Programa Sa√∫de na Escola";
            document.getElementById('modal-body').innerHTML = `
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-teal-100 rounded-xl flex items-center justify-center text-xl">üè´</div>
                        <div>
                            <h4 class="text-sm font-bold text-slate-800">${school}</h4>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Escola Pactuada</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <p class="text-[10px] font-black text-teal-600 uppercase mb-1">A√ß√£o Planejada</p>
                            <p class="text-xs font-bold text-slate-700">Avaliar resultados das a√ß√µes do 2¬∫ semestre de 2025 - GTIM</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-white rounded-xl border"><span class="block text-[9px] text-slate-400 uppercase font-bold">Respons√°vel</span><span class="text-[11px] font-bold">Reuni√£o Intersetorial</span></div>
                            <div class="p-3 bg-white rounded-xl border"><span class="block text-[9px] text-slate-400 uppercase font-bold">Registro</span><span class="text-[11px] font-bold">Ficha Coletiva</span></div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>